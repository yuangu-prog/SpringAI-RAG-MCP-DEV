<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¹è¯åŠ©æ‰‹ - LaGoGo</title>
    <!-- Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .message.assistant .message-content.streaming {
            border-left: 3px solid #667eea;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 80px;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            ğŸ¤– AI å¯¹è¯åŠ©æ‰‹ - LaGoGo
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
        const uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let currentEventSource = null;
        let currentAssistantMessage = null;

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || sendButton.disabled) {
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessage('user', message);
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendButton.disabled = true;
            sendButton.textContent = 'å‘é€ä¸­...';

            // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å ä½ç¬¦
            currentAssistantMessage = addMessage('assistant', '');
            currentAssistantMessage.classList.add('streaming');

            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (currentEventSource) {
                currentEventSource.close();
            }

            // ä½¿ç”¨ fetch + ReadableStream æ¥æ”¶ SSE æµ
            fetch('/api/v1/chat/sse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    uid: uid,
                    userInput: message
                })
            }).then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                console.log('SSEè¿æ¥å·²å»ºç«‹');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log('SSEæµè¯»å–å®Œæˆ');
                            if (currentAssistantMessage) {
                                currentAssistantMessage.classList.remove('streaming');
                            }
                            sendButton.disabled = false;
                            sendButton.textContent = 'å‘é€';
                            return;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        // SSEäº‹ä»¶ç”±ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš”
                        const chunks = buffer.split('\n\n');
                        buffer = chunks.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„å—

                        chunks.forEach(chunk => {
                            if (!chunk.trim()) return;
                            
                            const lines = chunk.split('\n');
                            let eventType = 'message'; // é»˜è®¤äº‹ä»¶ç±»å‹
                            let data = '';

                            // è§£æSSEæ ¼å¼: event: xxx å’Œ data: xxx
                            lines.forEach(line => {
                                const trimmedLine = line.trim();
                                if (trimmedLine.startsWith('event:')) {
                                    eventType = trimmedLine.substring(6).trim();
                                } else if (trimmedLine.startsWith('data:')) {
                                    data = trimmedLine.substring(5).trim();
                                } else if (trimmedLine && !trimmedLine.startsWith('event:') && !trimmedLine.startsWith('data:')) {
                                    // å¤„ç†æ²¡æœ‰å‰ç¼€çš„æ•°æ®è¡Œ
                                    if (!data) {
                                        data = trimmedLine;
                                    }
                                }
                            });

                            console.log('æ”¶åˆ°SSEäº‹ä»¶:', eventType, 'æ•°æ®:', data);

                            if (data === '[DONE]') {
                                console.log('æ”¶åˆ°å®Œæˆæ ‡è®°');
                                if (currentAssistantMessage) {
                                    currentAssistantMessage.classList.remove('streaming');
                                }
                                sendButton.disabled = false;
                                sendButton.textContent = 'å‘é€';
                                return;
                            }

                            // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                            if (currentAssistantMessage) {
                                const contentDiv = currentAssistantMessage.querySelector('.message-content');
                                if (contentDiv) {
                                    if (eventType === 'message') {
                                        // æµå¼æ¶ˆæ¯ï¼Œè¿½åŠ å†…å®¹
                                        contentDiv.textContent += data;
                                        scrollToBottom();
                                    } else if (eventType === 'add') {
                                        // æ·»åŠ æ–°æ¶ˆæ¯ï¼Œå¯ä»¥è¿½åŠ æˆ–æ›¿æ¢
                                        if (data) {
                                            contentDiv.textContent += data;
                                            scrollToBottom();
                                        }
                                    } else if (eventType === 'finish' || eventType === 'done') {
                                        // å®Œæˆæ¶ˆæ¯
                                        console.log('æµå¼å“åº”å®Œæˆ');
                                        currentAssistantMessage.classList.remove('streaming');
                                        sendButton.disabled = false;
                                        sendButton.textContent = 'å‘é€';
                                    } else if (eventType === 'error') {
                                        // é”™è¯¯æ¶ˆæ¯
                                        console.error('æ”¶åˆ°é”™è¯¯:', data);
                                        showError(data || 'å‘ç”ŸæœªçŸ¥é”™è¯¯');
                                        currentAssistantMessage.classList.remove('streaming');
                                        sendButton.disabled = false;
                                        sendButton.textContent = 'å‘é€';
                                    }
                                }
                            }
                        });

                        readStream();
                    }).catch(error => {
                        console.error('è¯»å–æµå¤±è´¥:', error);
                        showError('è¯»å–å“åº”å¤±è´¥: ' + error.message);
                        sendButton.disabled = false;
                        sendButton.textContent = 'å‘é€';
                        if (currentAssistantMessage) {
                            currentAssistantMessage.classList.remove('streaming');
                        }
                    });
                }

                readStream();
            }).catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
                sendButton.disabled = false;
                sendButton.textContent = 'å‘é€';
                if (currentAssistantMessage) {
                    currentAssistantMessage.remove();
                }
            });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            return messageDiv;
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ç»‘å®šäº‹ä»¶
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯
        window.addEventListener('load', function() {
            addMessage('assistant', 'ä½ å¥½ï¼æˆ‘æ˜¯ LaGoGoï¼Œä½ çš„ AI åŠ©æ‰‹ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ');
        });
    </script>
</body>
</html>

